{"ast":null,"code":"var _jsxFileName = \"/Users/sarah/Documents/Sarah/Projects/reu/covid19-forecasting-market/frontend/src/components/InteractiveChart/index.js\";\nimport React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport './InteractiveChart.css';\nimport { clamp, callout } from '../../utils/data';\nimport { elementType } from 'prop-types';\nimport { addDays, formatDate } from '../../utils/date';\n\nclass InteractiveChart extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      category: \"us_daily_deaths\"\n    };\n    this.chartRef = React.createRef();\n  }\n\n  componentDidMount() {\n    //console.log(this.props);\n    this.renderChart();\n  } //move to utils\n\n\n  savePrediction(data, category) {\n    fetch('/update/', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        \"data\": data,\n        \"category\": category\n      })\n    });\n  }\n\n  deletePrediction(category) {\n    console.log(category);\n    fetch('/delete/', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        \"category\": category\n      })\n    });\n    console.log(\"deleted\");\n  }\n\n  resetUserPrediction(predStartDate, predEndDate) {\n    var defaultPredictionData = [];\n    var currDate = predStartDate;\n    var defined = true; //var value = confirmedData[confirmedData.length - 1].value;\n    //check if userPrediction already exists in db\n\n    if (Object.keys(userPrediction).length > 0) {\n      predictionData = predictionData.filter(d => +d.date >= +predStartDate && +d.date <= +predEndDate);\n      predictionData[0].value = value;\n      defined = false;\n      value = 0;\n      currDate = addDays(predictionData[predictionData.length - 1].date, 1);\n    } //create defaultPredictionData\n\n\n    var tempDate = predStartDate;\n    var tempVal = confirmedLastVal;\n\n    while (+tempDate <= +predEndDate) {\n      defaultPredictionData.push({\n        date: tempDate,\n        value: tempVal,\n        defined: 0\n      });\n      tempVal = 0;\n      tempDate = addDays(tempDate, 1);\n    }\n\n    console.log(defaultPredictionData); //initialize data\n\n    while (+currDate <= +predEndDate) {\n      predictionData.push({\n        date: currDate,\n        value: value,\n        defined: defined\n      });\n      currDate = addDays(currDate, 1);\n      defined = 0;\n      value = 0;\n    }\n  }\n\n  renderChart() {\n    const {\n      forecast,\n      orgs,\n      userPrediction,\n      confirmed,\n      aggregate\n    } = this.props;\n    var predictionData = []; //where we will store formatted userPrediction\n\n    var defaultPredictionData = [];\n    const savePrediction = this.savePrediction;\n    const category = this.state.category;\n    var compiledData = []; //set up margin, width, height of chart\n\n    var legendWidth = 180;\n    var toolTipHeight = 50; //to make sure there's room for the tooltip when the value is 0\n\n    var margin = {\n      top: 20,\n      right: 30,\n      bottom: 20,\n      left: 60\n    },\n        width = 800 - margin.left - margin.right,\n        height = 400 - margin.top - margin.bottom;\n    var svg = d3.select(this.chartRef.current).append(\"svg\").attr(\"width\", width + margin.left + margin.right + legendWidth).attr(\"height\", height + margin.top + margin.bottom + toolTipHeight).append(\"g\").attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\"); //format confirmedData, forecastData, and predictionData into a list of js objects, convert date from string to js date object\n\n    var confirmedData = Object.keys(confirmed).map(key => ({\n      date: d3.timeParse(\"%Y-%m-%d\")(key),\n      value: confirmed[key]\n    }));\n    var forecastData = forecast.map(f => {\n      return Object.keys(f).map(key => ({\n        date: d3.timeParse(\"%Y-%m-%d\")(key),\n        value: f[key]\n      }));\n    });\n    var aggregateData = Object.keys(aggregate).map(key => ({\n      date: d3.timeParse(\"%Y-%m-%d\")(key),\n      value: aggregate[key]\n    })); //store userPrediction in predictionData if it exists\n\n    if (Object.keys(userPrediction).length > 0) {\n      predictionData = userPrediction.map(p => ({\n        date: d3.timeParse(\"%Y-%m-%d\")(p.date.substring(0, 10)),\n        value: p.value,\n        defined: p.defined\n      }));\n    } //set other dates\n\n\n    var confirmedStartDate = d3.timeParse(\"%Y-%m-%d\")(\"2020-02-01\"); //date format: y-m-d\n\n    var predStartDate = confirmedData[confirmedData.length - 1].date; //last date of confirmedData\n\n    var predLength = 365;\n    var predEndDateString = addDays(new Date(), predLength).toISOString().substring(0, 10);\n    var predEndDate = d3.timeParse(\"%Y-%m-%d\")(predEndDateString); //get confirmedData starting from confirmedStartDate\n\n    confirmedData = confirmedData.filter(d => +d.date >= +confirmedStartDate); //draw x-axis        \n\n    var x = d3.scaleTime().domain([confirmedStartDate, predEndDate]).range([0, width]); //.nice(); //rounds up/down the max and mind of x axis\n\n    svg.append(\"g\").attr(\"transform\", \"translate(0,\" + height + \")\").call(d3.axisBottom(x)); //find max val in confirmedData and forecastData to determine the max of y-axis\n\n    var confirmedMax = d3.max(confirmedData, function (d) {\n      return +d.value;\n    });\n    var forecastMax = 0;\n    forecastData.map(f => {\n      var currMax = d3.max(f, d => {\n        return d.value;\n      });\n      forecastMax = currMax > forecastMax ? currMax : forecastMax;\n    });\n    var yAxisMax = Math.max(confirmedMax, forecastMax); //draw y-axis\n\n    var y = d3.scaleLinear().domain([0, yAxisMax]).range([height, 0]).nice();\n    svg.append(\"g\").call(d3.axisLeft(y)); //list of data displayed in graph - for legend\n\n    var legendString = orgs.concat([\"Daily Confirmed Deaths\", \"Aggregate Forecast\", \"User Prediction\"]); //color function that assigns random colors to each data\n\n    var color = d3.scaleOrdinal().domain(legendString).range(d3.schemeTableau10); //draw legend\n\n    var legend = svg.append('g').attr(\"id\", \"legend\");\n    var size = 10;\n    legend.selectAll(\"rect\").data(legendString).enter().append(\"circle\").attr('cx', width + 30).attr(\"cy\", function (d, i) {\n      return 20 + i * 25;\n    }) // 100 is where the first dot appears. 25 is the distance between dots\n    .attr(\"r\", 6) //.attr(\"width\", size)\n    //.attr(\"height\", size)\n    .style(\"fill\", function (d) {\n      return color(d);\n    });\n    legend.selectAll(\"labels\").data(legendString).enter().append(\"text\").attr(\"x\", width + 45).attr(\"y\", function (d, i) {\n      return 20 + i * 25;\n    }) // 100 is where the first dot appears. 25 is the distance between dots\n    .style(\"fill\", function (d) {\n      return color(d);\n    }).text(function (d) {\n      return d;\n    }).attr(\"text-anchor\", \"left\").style(\"alignment-baseline\", \"middle\"); //create line generator for confirmed/forecast data and prediction data\n\n    var lineGenerator = d3.line().curve(d3.curveCatmullRom); //curve that goes through all data points\n\n    var predLineGenerator = d3.line().curve(d3.curveBasis); //curve doesn't go through all data points (it's smoothed out)\n    //d3.curveMonotoneX\n    //d3.curveBasis\n    //d3.curveCardinal\n    //function that draws curve\n\n    var line = lineGenerator.x(function (d) {\n      return x(d.date);\n    }).y(function (d) {\n      return y(d.value);\n    }); //display confirmed data\n\n    var confirmedLine = svg.append(\"path\").attr(\"id\", \"confirmed\").attr(\"class\", \"line\").datum(confirmedData).attr('d', line).attr(\"stroke\", color(legendString[legendString.length - 3])); //display aggregate data\n\n    var aggregateLine = svg.append(\"path\").attr(\"id\", \"aggregate\").attr(\"class\", \"line\").datum(aggregateData).attr('d', line).attr(\"stroke\", color(legendString[legendString.length - 2])); //display forecast data\n\n    forecastData.map((f, index) => {\n      svg.append(\"path\").attr(\"class\", \"forecast line\").attr(\"id\", orgs[index]).style(\"stroke\", color(orgs[index])).datum(f).attr(\"d\", line);\n    });\n    var lines = document.getElementsByClassName('line'); //function that generates the prediction curve\n\n    var predLine = predLineGenerator.defined(d => d.defined).x(function (d) {\n      return x(d.date);\n    }).y(function (d) {\n      return y(d.value);\n    }); //append path for prediction data\n\n    var yourLine = svg.append(\"path\").attr(\"id\", \"your-line\"); //variables used to initialize user prediction data if it doesn't exist in the db\n\n    var currDate = predStartDate;\n    var defined = true;\n    var value = confirmedData[confirmedData.length - 1].value;\n    const confirmedLastVal = value; //used to make sure the first data point of prediction stays the same\n    //check if userPrediction already exists in db\n\n    if (Object.keys(userPrediction).length > 0) {\n      predictionData = predictionData.filter(d => +d.date >= +predStartDate && +d.date <= +predEndDate);\n      predictionData[0].value = value;\n      defined = false;\n      value = 0;\n      currDate = addDays(predictionData[predictionData.length - 1].date, 1);\n    } //create defaultPredictionData\n\n\n    var tempDate = predStartDate;\n    var tempVal = confirmedLastVal;\n\n    while (+tempDate <= +predEndDate) {\n      defaultPredictionData.push({\n        date: tempDate,\n        value: tempVal,\n        defined: 0\n      });\n      tempVal = 0;\n      tempDate = addDays(tempDate, 1);\n    }\n\n    console.log(defaultPredictionData); //initialize data\n\n    while (+currDate <= +predEndDate) {\n      predictionData.push({\n        date: currDate,\n        value: value,\n        defined: defined\n      });\n      currDate = addDays(currDate, 1);\n      defined = 0;\n      value = 0;\n    }\n\n    var filteredData = null; //var totalData = confirmedData.concat(predictionData);\n    //!!    //add forecast data to compiledData\n\n    orgs.map((o, index) => {\n      compiledData.push({\n        name: o,\n        data: forecastData[index]\n      });\n    });\n    compiledData.push({\n      name: \"Daily Confirmed Deaths\",\n      data: confirmedData\n    });\n    compiledData.push({\n      name: \"Aggregate Forecast\",\n      data: aggregateData\n    }); //if (userPrediction) {\n\n    compiledData.push({\n      name: \"User Prediction\",\n      data: predictionData\n    });\n    console.log(confirmedData);\n    console.log(predictionData); //}\n    //join data to yourLine\n\n    if (Object.keys(userPrediction).length > 0) {\n      filteredData = predictionData.filter(predLine.defined());\n      yourLine.datum(filteredData).attr('d', predLine).style(\"stroke\", color(legendString[legendString.length - 1]));\n    } //append new rect  \n\n\n    const mouseArea = svg.append(\"rect\").attr(\"width\", width).attr(\"height\", height).attr(\"fill\", \"none\").style(\"pointer-events\", \"visible\"); //append click area rect\n\n    var confirmedAreaWidth = confirmedLine.node().getBoundingClientRect().width; //get width of path element containing confirmed data\n\n    var clickAreaWidth = width - confirmedAreaWidth; //the remaining area\n\n    svg.append(\"rect\").attr(\"id\", \"click-area\").attr(\"width\", clickAreaWidth).attr(\"height\", height).attr(\"transform\", \"translate (\" + confirmedAreaWidth + \" 0)\").attr(\"fill\", \"none\").style(\"pointer-events\", \"visible\"); //var clickArea = d3.select(\"#click-area\");\n    //append circle at the end of confirmed curve\n\n    /*var selectCircle = svg\n                            .append(\"g\")\n                            .attr(\"class\", \"pointer\")\n    var pointerCircles = [\"pulse-disk\", \"pulse-circle\", \"pulse-circle-2\"];\n    pointerCircles.map((c) => {\n        selectCircle.append(\"circle\")\n                    .attr(\"class\", c)\n                    .attr(\"cx\", x(confirmedData[confirmedData.length - 1].date))\n                    .attr(\"cy\", y(confirmedData[confirmedData.length - 1].value))\n    })*/\n\n    if (Object.keys(userPrediction).length == 0) {\n      //append draw your guess text\n      svg.append(\"text\").attr(\"id\", \"draw-guess\").attr(\"x\", confirmedAreaWidth + clickAreaWidth / 2).attr(\"y\", height - 60).attr(\"text-anchor\", \"middle\").style(\"font-size\", \"16px\").text(\"Draw your guess\"); //append circle at the end of confirmed curve\n\n      var selectCircle = svg.append(\"g\").attr(\"class\", \"pointer\");\n      var pointerCircles = [\"pulse-disk\", \"pulse-circle\", \"pulse-circle-2\"];\n      pointerCircles.map(c => {\n        selectCircle.append(\"circle\").attr(\"class\", c).attr(\"cx\", x(confirmedData[confirmedData.length - 1].date)).attr(\"cy\", y(confirmedData[confirmedData.length - 1].value));\n      });\n    }\n\n    var drag = d3.drag().on(\"drag\", function () {\n      //hide \"draw your guess\" text\n      d3.select(\"#draw-guess\").remove();\n      d3.select(\".pointer\").remove();\n      d3.select(\"#tooltip-line\").style(\"opacity\", \"0\");\n      d3.selectAll(\".mouse-per-line circle\").style(\"opacity\", \"0\");\n      d3.selectAll(\".mouse-per-line text\").style(\"opacity\", \"0\");\n      var pos = d3.mouse(this);\n      var date = clamp(predStartDate, predEndDate, x.invert(pos[0]));\n      var value = clamp(0, yAxisMax, y.invert(pos[1]));\n      predictionData.forEach(function (d) {\n        if (+d3.timeDay.round(d.date) == +d3.timeDay.round(date)) {\n          d.value = value;\n          d.defined = true;\n        }\n\n        predictionData[0].value = confirmedLastVal; //make sure the prediction curve is always connected to the confirmed curve\n        //update totalData everytime predictionData is updated\n\n        compiledData[compiledData.length - 1].data = predictionData; //console.log(compiledData)\n\n        /*yourLine.datum(predictionData)\n                .attr('d', predLine)*/\n\n        var filteredData = predictionData.filter(predLine.defined());\n        yourLine.datum(filteredData).attr('d', predLine).style(\"stroke\", color(legendString[legendString.length - 1]));\n      });\n    }).on(\"end\", function () {\n      savePrediction(predictionData, category);\n      d3.select(\"#tooltip-line\").style(\"opacity\", \"1\");\n      d3.selectAll(\".mouse-per-line circle\").style(\"opacity\", \"1\");\n      d3.selectAll(\".mouse-per-line text\").style(\"opacity\", \"1\");\n    });\n    svg.call(drag); //finds the datapoint closest to the mouse (along x)\n\n    /*var bisect = () => {\n        const bisectDate = d3.bisector(d => d.date).left;\n        return mx => {\n            const date = x.invert(mx);\n            const index = bisectDate(totalData, date, 1);\n            const a = totalData[index - 1];\n            const b = totalData[index];\n            return b && (date - a.date > b.date - date) ? b : a;\n        };\n    }*/\n\n    const tooltipArea = svg.append(\"g\").attr(\"class\", \"tooltip\");\n    tooltipArea.append(\"path\") //vertical line\n    .attr(\"id\", \"tooltip-line\").style(\"stroke\", \"black\").style(\"stroke-width\", \"0.5px\").style(\"opacity\", \"0\");\n    var mousePerLine = tooltipArea.selectAll(\".mouse-per-line\").data(compiledData).enter().append(\"g\").attr(\"class\", \"mouse-per-line\");\n    mousePerLine.append(\"circle\").attr(\"r\", 2).style(\"stroke\", function (d) {\n      return color(d.name);\n    }).style(\"fill\", \"none\").style(\"stroke-width\", \"1px\").style(\"opacity\", \"0\");\n    mousePerLine.append(\"text\").attr(\"transform\", \"translate(10,3)\");\n    tooltipArea.append(\"svg:rect\").attr('width', width).attr('height', height).attr('fill', 'none').attr('pointer-events', 'all').on('mouseout', function () {\n      // on mouse out hide line, circles and text\n      d3.select(\"#tooltip-line\").style(\"opacity\", \"0\");\n      d3.selectAll(\".mouse-per-line circle\").style(\"opacity\", \"0\");\n      d3.selectAll(\".mouse-per-line text\").style(\"opacity\", \"0\");\n    }).on('mouseover', function () {\n      // on mouse in show line, circles and text\n      d3.select(\"#tooltip-line\").style(\"opacity\", \"1\");\n      d3.selectAll(\".mouse-per-line circle\").style(\"opacity\", \"1\");\n      d3.selectAll(\".mouse-per-line text\").style(\"opacity\", \"1\");\n    }).on('mousemove', function () {\n      // mouse moving over canvas\n      var mouse = d3.mouse(this);\n      var xCoord = mouse[0];\n      d3.select(\"#tooltip-line\").attr(\"d\", function () {\n        var d = \"M\" + xCoord + \",\" + height;\n        d += \" \" + xCoord + \",\" + 0;\n        return d;\n      });\n      d3.selectAll(\".mouse-per-line\").attr(\"transform\", function (d, i) {\n        if (d.data.length == 0) {\n          return;\n        }\n\n        var date = x.invert(xCoord);\n        const index = d3.bisector(f => f.date).left(compiledData[i].data, date);\n        var a = null;\n\n        if (index > 0) {\n          a = d.data[index - 1];\n        }\n\n        const b = d.data[index]; //d = the data object corresponding to date and value pointed by the cursors\n\n        var data = null;\n\n        if (!a) {\n          data = b;\n        } else if (!b) {\n          data = a;\n        } else {\n          data = b && date - a.date > b.date - date ? b : a;\n        }\n\n        if (+d3.timeDay.floor(date) == +data.date || +d3.timeDay.ceil(date) == +data.date) {\n          if (data.defined != 0) {\n            var element = d3.select(this).select('text').style(\"opacity\", \"1\").text(Math.round(data.value).toFixed(2));\n            element.select(\"circle\").style(\"opacity\", \"1\");\n            return \"translate(\" + mouse[0] + \",\" + y(data.value) + \")\";\n          }\n        }\n\n        var element = d3.select(this).select(\"text\").style(\"opacity\", \"0\");\n        element.select(\"circle\").style(\"opacity\", \"0\");\n      });\n    }); ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n    var deleteButton = document.createElement(\"button\");\n    deleteButton.innerText = \"Delete\";\n\n    deleteButton.onclick = () => {\n      this.deletePrediction(category);\n      predictionData = [Object.assign({}, defaultPredictionData)];\n      console.log(predictionData); //update yourLine\n\n      var filtered = predictionData.filter(predLine.defined());\n      console.log(filtered);\n      yourLine.datum(filtered).attr('d', predLine);\n    };\n\n    document.querySelector(\"body\").appendChild(deleteButton);\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      ref: this.chartRef,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 540,\n        columnNumber: 16\n      }\n    });\n  }\n\n}\n\nexport default InteractiveChart;","map":{"version":3,"sources":["/Users/sarah/Documents/Sarah/Projects/reu/covid19-forecasting-market/frontend/src/components/InteractiveChart/index.js"],"names":["React","Component","d3","clamp","callout","elementType","addDays","formatDate","InteractiveChart","constructor","props","state","category","chartRef","createRef","componentDidMount","renderChart","savePrediction","data","fetch","method","headers","body","JSON","stringify","deletePrediction","console","log","resetUserPrediction","predStartDate","predEndDate","defaultPredictionData","currDate","defined","Object","keys","userPrediction","length","predictionData","filter","d","date","value","tempDate","tempVal","confirmedLastVal","push","forecast","orgs","confirmed","aggregate","compiledData","legendWidth","toolTipHeight","margin","top","right","bottom","left","width","height","svg","select","current","append","attr","confirmedData","map","key","timeParse","forecastData","f","aggregateData","p","substring","confirmedStartDate","predLength","predEndDateString","Date","toISOString","x","scaleTime","domain","range","call","axisBottom","confirmedMax","max","forecastMax","currMax","yAxisMax","Math","y","scaleLinear","nice","axisLeft","legendString","concat","color","scaleOrdinal","schemeTableau10","legend","size","selectAll","enter","i","style","text","lineGenerator","line","curve","curveCatmullRom","predLineGenerator","curveBasis","confirmedLine","datum","aggregateLine","index","lines","document","getElementsByClassName","predLine","yourLine","filteredData","o","name","mouseArea","confirmedAreaWidth","node","getBoundingClientRect","clickAreaWidth","selectCircle","pointerCircles","c","drag","on","remove","pos","mouse","invert","forEach","timeDay","round","tooltipArea","mousePerLine","xCoord","bisector","a","b","floor","ceil","element","toFixed","deleteButton","createElement","innerText","onclick","assign","filtered","querySelector","appendChild","render"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport * as d3 from 'd3'\nimport './InteractiveChart.css';\nimport { clamp, callout } from '../../utils/data';\nimport { elementType } from 'prop-types';\nimport { addDays, formatDate } from '../../utils/date';\n\n\nclass InteractiveChart extends Component {\n    constructor(props) {\n        super(props);\n        this.state = { category: \"us_daily_deaths\" };\n        this.chartRef = React.createRef();\n    }\n    componentDidMount() {\n        //console.log(this.props);\n        this.renderChart();\n    }\n\n    //move to utils\n    savePrediction(data, category) {\n        fetch('/update/',{\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\"data\": data, \"category\": category}),\n        });\n    }\n    deletePrediction(category) {\n        console.log(category)\n        fetch('/delete/',{\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\"category\": category}),\n          });\n        console.log(\"deleted\")\n    }\n\n    resetUserPrediction(predStartDate, predEndDate) {\n        var defaultPredictionData = [];\n        var currDate = predStartDate;\n        var defined = true;\n        //var value = confirmedData[confirmedData.length - 1].value;\n        \n        //check if userPrediction already exists in db\n        if (Object.keys(userPrediction).length > 0) {\n            predictionData = predictionData.filter(d => (+d.date >= +predStartDate) && (+d.date <= +predEndDate));\n            predictionData[0].value = value;\n            defined = false;\n            value = 0;\n            currDate = addDays(predictionData[predictionData.length - 1].date, 1);\n        }\n        //create defaultPredictionData\n        var tempDate = predStartDate;\n        var tempVal = confirmedLastVal\n        while(+tempDate <= +predEndDate) {\n            defaultPredictionData.push({date: tempDate, value: tempVal, defined: 0});\n            tempVal = 0;\n            tempDate = addDays(tempDate, 1);\n        }\n        console.log(defaultPredictionData)\n        //initialize data\n        while (+currDate <= +predEndDate) {            \n            predictionData.push({date: currDate, value: value, defined: defined});\n            currDate = addDays(currDate, 1);\n            defined = 0;\n            value = 0;\n        }\n    }\n\n    renderChart() {\n        const { forecast, orgs, userPrediction, confirmed, aggregate } = this.props;\n        var predictionData = [];//where we will store formatted userPrediction\n        var defaultPredictionData = []\n        const savePrediction = this.savePrediction;\n        const category = this.state.category;\n        var compiledData = [];\n        //set up margin, width, height of chart\n        var legendWidth = 180;\n        var toolTipHeight = 50; //to make sure there's room for the tooltip when the value is 0\n        var margin = {top: 20, right: 30, bottom: 20, left: 60},\n            width = 800 - margin.left - margin.right,\n            height = 400 - margin.top - margin.bottom;\n        var svg = d3.select(this.chartRef.current)\n                    .append(\"svg\")\n                        .attr(\"width\", width + margin.left + margin.right + legendWidth)\n                        .attr(\"height\", height + margin.top + margin.bottom + toolTipHeight)\n                    .append(\"g\")\n                        .attr(\"transform\",\n                        \"translate(\" + margin.left + \",\" + margin.top + \")\");\n        \n        //format confirmedData, forecastData, and predictionData into a list of js objects, convert date from string to js date object\n        var confirmedData = Object.keys(confirmed).map(key => ({\n            date: d3.timeParse(\"%Y-%m-%d\")(key),\n            value: confirmed[key]\n        }));\n        \n        var forecastData = forecast.map(f => {\n            return Object.keys(f).map(key => ({\n                date: d3.timeParse(\"%Y-%m-%d\")(key),\n                value: f[key]\n            }))\n        });\n\n        var aggregateData = Object.keys(aggregate).map(key => ({\n            date: d3.timeParse(\"%Y-%m-%d\")(key),\n            value: aggregate[key]\n        }));\n        //store userPrediction in predictionData if it exists\n        if(Object.keys(userPrediction).length > 0) {\n            predictionData = userPrediction.map(p => ({\n                date: d3.timeParse(\"%Y-%m-%d\")((p.date).substring(0,10)),\n                value: p.value,\n                defined: p.defined\n                })\n            );\n        }\n  \n\n        //set other dates\n        var confirmedStartDate = d3.timeParse(\"%Y-%m-%d\")(\"2020-02-01\"); //date format: y-m-d\n        var predStartDate = confirmedData[confirmedData.length - 1].date; //last date of confirmedData\n        var predLength = 365;\n        var predEndDateString = addDays(new Date(), predLength).toISOString().substring(0, 10);\n        var predEndDate = d3.timeParse(\"%Y-%m-%d\")(predEndDateString)\n        \n        //get confirmedData starting from confirmedStartDate\n        confirmedData = confirmedData.filter(d => +d.date >= +confirmedStartDate);\n\n        //draw x-axis        \n        var x = d3.scaleTime()\n            .domain([confirmedStartDate, predEndDate])\n            .range([ 0, width ])\n            //.nice(); //rounds up/down the max and mind of x axis\n         svg.append(\"g\")\n            .attr(\"transform\", \"translate(0,\" + height + \")\")\n            .call(d3.axisBottom(x));\n        \n        //find max val in confirmedData and forecastData to determine the max of y-axis\n        var confirmedMax = d3.max(confirmedData, function(d) { return +d.value; });\n        var forecastMax = 0;\n        forecastData.map(f => {\n            var currMax = d3.max(f, d => {return d.value;})\n            forecastMax = currMax > forecastMax ? currMax : forecastMax;\n        })\n        var yAxisMax = Math.max(confirmedMax, forecastMax);\n        //draw y-axis\n        var y = d3.scaleLinear()\n            .domain([0, yAxisMax])\n            .range([ height, 0 ])\n            .nice();\n        svg.append(\"g\")\n            .call(d3.axisLeft(y));\n   \n        //list of data displayed in graph - for legend\n        var legendString = orgs.concat([\"Daily Confirmed Deaths\", \"Aggregate Forecast\", \"User Prediction\"]);\n        //color function that assigns random colors to each data\n        var color = d3\n                        .scaleOrdinal()\n                        .domain(legendString)\n                        .range(d3.schemeTableau10);\n\n         //draw legend\n        var legend = svg.append('g')\n                        .attr(\"id\", \"legend\")\n        var size = 10;\n        legend.selectAll(\"rect\")\n            .data(legendString)\n            .enter()\n            .append(\"circle\")\n                .attr('cx', width + 30)\n                .attr(\"cy\", function(d,i){ return 20 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots\n                .attr(\"r\", 6)\n                //.attr(\"width\", size)\n                //.attr(\"height\", size)\n                .style(\"fill\", function(d){ return color(d)})\n        legend.selectAll(\"labels\")\n            .data(legendString)\n            .enter()\n            .append(\"text\")\n                .attr(\"x\", width + 45)\n                .attr(\"y\", function(d,i){ return 20 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots\n                .style(\"fill\", function(d){ return color(d)})\n                .text(function(d){ return d})\n                    .attr(\"text-anchor\", \"left\")\n                    .style(\"alignment-baseline\", \"middle\")\n\n        //create line generator for confirmed/forecast data and prediction data\n        var lineGenerator = d3.line()\n            .curve(d3.curveCatmullRom)//curve that goes through all data points\n        var predLineGenerator = d3.line()\n            .curve(d3.curveBasis); //curve doesn't go through all data points (it's smoothed out)\n            //d3.curveMonotoneX\n            //d3.curveBasis\n            //d3.curveCardinal\n        \n        //function that draws curve\n        var line = lineGenerator\n            .x(function(d) { return x(d.date) })\n            .y(function(d) { return y(d.value) })\n        \n        //display confirmed data\n        var confirmedLine = svg\n            .append(\"path\")\n            .attr(\"id\", \"confirmed\")\n            .attr(\"class\", \"line\")    \n            .datum(confirmedData)    \n            .attr('d', line)\n            .attr(\"stroke\", color(legendString[legendString.length - 3]))\n\n        //display aggregate data\n        var aggregateLine = svg\n            .append(\"path\")\n            .attr(\"id\", \"aggregate\")\n            .attr(\"class\", \"line\")        \n            .datum(aggregateData)    \n            .attr('d', line)\n            .attr(\"stroke\", color(legendString[legendString.length - 2]))\n        \n        //display forecast data\n        forecastData.map((f, index) => {\n            svg\n                .append(\"path\")\n                    .attr(\"class\", \"forecast line\")\n                    .attr(\"id\", orgs[index])\n                    .style(\"stroke\", color(orgs[index]))\n                .datum(f)\n                    .attr(\"d\", line);\n        })\n        \n        var lines = document.getElementsByClassName('line');\n\n        //function that generates the prediction curve\n        var predLine = predLineGenerator\n            .defined(d => d.defined)\n            .x(function(d) { return x(d.date) })\n            .y(function(d) { return y(d.value) })\n\n        //append path for prediction data\n        var yourLine = svg.append(\"path\")\n                .attr(\"id\", \"your-line\");\n        \n        //variables used to initialize user prediction data if it doesn't exist in the db\n        var currDate = predStartDate;\n        var defined = true;\n        var value = confirmedData[confirmedData.length - 1].value;\n        const confirmedLastVal = value; //used to make sure the first data point of prediction stays the same\n        \n        //check if userPrediction already exists in db\n        if (Object.keys(userPrediction).length > 0) {\n            predictionData = predictionData.filter(d => (+d.date >= +predStartDate) && (+d.date <= +predEndDate));\n            predictionData[0].value = value;\n            defined = false;\n            value = 0;\n            currDate = addDays(predictionData[predictionData.length - 1].date, 1);\n        }\n        //create defaultPredictionData\n        var tempDate = predStartDate;\n        var tempVal = confirmedLastVal\n        while(+tempDate <= +predEndDate) {\n            defaultPredictionData.push({date: tempDate, value: tempVal, defined: 0});\n            tempVal = 0;\n            tempDate = addDays(tempDate, 1);\n        }\n        console.log(defaultPredictionData)\n        //initialize data\n        while (+currDate <= +predEndDate) {            \n            predictionData.push({date: currDate, value: value, defined: defined});\n            currDate = addDays(currDate, 1);\n            defined = 0;\n            value = 0;\n        }\n        var filteredData = null;\n        //var totalData = confirmedData.concat(predictionData);\n\n//!!    //add forecast data to compiledData\n        orgs.map((o, index) => {\n            compiledData.push({\n                name: o,\n                data: forecastData[index]\n            })\n        })\n        compiledData.push({\n            name: \"Daily Confirmed Deaths\",\n            data: confirmedData\n        })\n        compiledData.push({\n            name: \"Aggregate Forecast\",\n            data: aggregateData\n        })\n        //if (userPrediction) {\n        compiledData.push({\n            name: \"User Prediction\",\n            data: predictionData\n        })\n        console.log(confirmedData);\n        console.log(predictionData)\n        //}\n        //join data to yourLine\n        if(Object.keys(userPrediction).length > 0) {\n            filteredData = predictionData.filter(predLine.defined())\n            yourLine.datum(filteredData)\n                    .attr('d', predLine)\n                    .style(\"stroke\", color(legendString[legendString.length - 1]))\n        }\n        //append new rect  \n        const mouseArea = svg.append(\"rect\")\n            .attr(\"width\", width)\n            .attr(\"height\", height)\n            .attr(\"fill\", \"none\")\n            .style(\"pointer-events\",\"visible\");\n\n        //append click area rect\n        var confirmedAreaWidth = confirmedLine.node().getBoundingClientRect().width; //get width of path element containing confirmed data\n        var clickAreaWidth = width - confirmedAreaWidth; //the remaining area\n        svg.append(\"rect\")\n           .attr(\"id\", \"click-area\")\n           .attr(\"width\", clickAreaWidth)\n           .attr(\"height\",height)\n           .attr(\"transform\", \"translate (\" + confirmedAreaWidth+\" 0)\")\n           .attr(\"fill\", \"none\")\n           .style(\"pointer-events\",\"visible\");\n        //var clickArea = d3.select(\"#click-area\");\n        \n        //append circle at the end of confirmed curve\n        /*var selectCircle = svg\n                                .append(\"g\")\n                                .attr(\"class\", \"pointer\")\n        var pointerCircles = [\"pulse-disk\", \"pulse-circle\", \"pulse-circle-2\"];\n        pointerCircles.map((c) => {\n            selectCircle.append(\"circle\")\n                        .attr(\"class\", c)\n                        .attr(\"cx\", x(confirmedData[confirmedData.length - 1].date))\n                        .attr(\"cy\", y(confirmedData[confirmedData.length - 1].value))\n        })*/\n\n        if(Object.keys(userPrediction).length == 0) {\n            //append draw your guess text\n            svg.append(\"text\")\n                .attr(\"id\", \"draw-guess\")\n                .attr(\"x\", confirmedAreaWidth + (clickAreaWidth / 2))             \n                .attr(\"y\", height - 60)\n                .attr(\"text-anchor\", \"middle\")  \n                .style(\"font-size\", \"16px\") \n                .text(\"Draw your guess\");\n            //append circle at the end of confirmed curve\n            var selectCircle = svg\n                                    .append(\"g\")\n                                    .attr(\"class\", \"pointer\")\n            var pointerCircles = [\"pulse-disk\", \"pulse-circle\", \"pulse-circle-2\"];\n            pointerCircles.map((c) => {\n            selectCircle.append(\"circle\")\n                .attr(\"class\", c)\n                .attr(\"cx\", x(confirmedData[confirmedData.length - 1].date))\n                .attr(\"cy\", y(confirmedData[confirmedData.length - 1].value))\n            })\n        }\n\n        var drag = d3.drag()\n                     .on(\"drag\", function() {\n                        //hide \"draw your guess\" text\n                        d3.select(\"#draw-guess\").remove()\n                        d3.select(\".pointer\").remove()\n                        d3.select(\"#tooltip-line\")\n                            .style(\"opacity\", \"0\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                            .style(\"opacity\", \"0\");\n                        d3.selectAll(\".mouse-per-line text\")\n                            .style(\"opacity\", \"0\")\n                        var pos = d3.mouse(this);\n                        var date = clamp(predStartDate, predEndDate, x.invert(pos[0]));\n                        var value = clamp(0, yAxisMax, y.invert(pos[1]));\n                        \n                        predictionData.forEach(function(d){\n                            if (+d3.timeDay.round(d.date) == +d3.timeDay.round(date)){\n                                d.value = value;\n                                d.defined = true\n                            }\n                        predictionData[0].value = confirmedLastVal;//make sure the prediction curve is always connected to the confirmed curve\n                        //update totalData everytime predictionData is updated\n                        compiledData[compiledData.length - 1].data = predictionData;\n                        //console.log(compiledData)\n                        /*yourLine.datum(predictionData)\n                                .attr('d', predLine)*/\n                        var filteredData = predictionData.filter(predLine.defined())\n\n                        yourLine.datum(filteredData)\n                                .attr('d', predLine)\n                                .style(\"stroke\", color(legendString[legendString.length - 1]))\n\n                        });\n                    })\n                    .on(\"end\", function () {\n                        savePrediction(predictionData, category);\n                        d3.select(\"#tooltip-line\")\n                            .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                            .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line text\")\n                            .style(\"opacity\", \"1\")\n                    });\n        \n        svg.call(drag)\n\n        //finds the datapoint closest to the mouse (along x)\n        /*var bisect = () => {\n            const bisectDate = d3.bisector(d => d.date).left;\n            return mx => {\n                const date = x.invert(mx);\n                const index = bisectDate(totalData, date, 1);\n                const a = totalData[index - 1];\n                const b = totalData[index];\n                return b && (date - a.date > b.date - date) ? b : a;\n            };\n        }*/\n\n\n        const tooltipArea = svg\n                                .append(\"g\")\n                                .attr(\"class\", \"tooltip\")\n\n        tooltipArea.append(\"path\") //vertical line\n                    .attr(\"id\", \"tooltip-line\")\n                    .style(\"stroke\", \"black\")\n                    .style(\"stroke-width\", \"0.5px\")\n                    .style(\"opacity\", \"0\");\n        \n        var mousePerLine = tooltipArea\n                                        .selectAll(\".mouse-per-line\")\n                                        .data(compiledData)\n                                        .enter()\n                                        .append(\"g\")\n                                        .attr(\"class\", \"mouse-per-line\");\n        \n        mousePerLine.append(\"circle\")\n                        .attr(\"r\", 2)\n                        .style(\"stroke\", function(d) {\n                            return color(d.name);\n                        })\n                        .style(\"fill\", \"none\")\n                        .style(\"stroke-width\", \"1px\")\n                        .style(\"opacity\", \"0\");\n        mousePerLine.append(\"text\")\n                    .attr(\"transform\", \"translate(10,3)\"); \n        tooltipArea\n                    .append(\"svg:rect\")\n                    .attr('width', width)\n                    .attr('height', height)\n                    .attr('fill', 'none')\n                    .attr('pointer-events', 'all')\n                    .on('mouseout', function() { // on mouse out hide line, circles and text\n                        d3.select(\"#tooltip-line\")\n                          .style(\"opacity\", \"0\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                          .style(\"opacity\", \"0\");\n                        d3.selectAll(\".mouse-per-line text\")\n                          .style(\"opacity\", \"0\")\n                    })\n                    .on('mouseover', function() { // on mouse in show line, circles and text\n                        d3.select(\"#tooltip-line\")\n                          .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                          .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line text\")\n                          .style(\"opacity\", \"1\")\n\n                    })\n                    .on('mousemove', function() { // mouse moving over canvas\n                        var mouse = d3.mouse(this);\n                        var xCoord = mouse[0];\n                        d3\n                            .select(\"#tooltip-line\")\n                            .attr(\"d\", function() {\n                                var d = \"M\" + xCoord + \",\" + height;\n                                d += \" \" + xCoord + \",\" + 0;\n                                return d;\n                            });\n                        d3\n                            .selectAll(\".mouse-per-line\")\n                            .attr(\"transform\", function(d, i) {\n                                if (d.data.length == 0) {return;}\n                                var date = x.invert(xCoord);\n                                const index = d3.bisector(f => f.date).left(compiledData[i].data, date);\n                                var a = null;\n                                if (index > 0) {\n                                    a = d.data[index - 1];\n                                }\n                                const b = d.data[index];\n                                //d = the data object corresponding to date and value pointed by the cursors\n                                var data = null;\n                                if (!a) {\n                                    data = b;\n                                }\n                                else if (!b) {\n                                    data = a;\n                                }\n                                else {\n                                    data = b && (date - a.date > b.date - date) ? b : a;\n                                }\n                                if (+d3.timeDay.floor(date) == +data.date || +d3.timeDay.ceil(date) == +data.date) {\n                                    if (data.defined != 0) {\n                                        var element = d3.select(this)\n                                                        .select('text')\n                                                            .style(\"opacity\", \"1\")\n                                                            .text(Math.round(data.value).toFixed(2));\n                                        element.select(\"circle\")\n                                                .style(\"opacity\", \"1\");\n                                        return \"translate(\" + mouse[0] + \",\" + y(data.value)+\")\";\n                                    }\n                                }\n                                var element = d3.select(this)\n                                                .select(\"text\")\n                                                .style(\"opacity\", \"0\")\n                                element\n                                        .select(\"circle\")\n                                        .style(\"opacity\", \"0\");\n                                \n                        });\n                    })\n        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n        var deleteButton = document.createElement(\"button\")\n        deleteButton.innerText = \"Delete\";\n        deleteButton.onclick = () => {\n            this.deletePrediction(category)\n            predictionData = [(Object.assign({}, defaultPredictionData))];\n            console.log(predictionData)\n            //update yourLine\n            var filtered = predictionData.filter(predLine.defined())\n            console.log(filtered)\n            yourLine.datum(filtered)\n                    .attr('d', predLine)\n        };\n        document.querySelector(\"body\").appendChild(deleteButton);\n    }\n        \n    render() {\n        return(<div ref={this.chartRef}></div>);\n    }\n}\n\nexport default InteractiveChart;"]},"metadata":{},"sourceType":"module"}