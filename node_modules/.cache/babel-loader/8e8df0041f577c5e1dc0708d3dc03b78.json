{"ast":null,"code":"var _jsxFileName = \"/Users/sarah/Documents/Sarah/Projects/reu/covid19-forecasting-market/frontend/src/components/UserPredictionChart/index.js\";\nimport React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport './UserPredictionChart.css';\nimport { getMostRecentPrediction, getAllDataPoints, sortDictByDate, sortStringDates } from '../../utils/data';\n\nclass UserPredictionChart extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      category: \"us_daily_deaths\"\n    };\n    this.chartRef = React.createRef();\n  }\n\n  componentDidMount() {\n    const userStatus = this.props.userStatus;\n    console.log(userStatus);\n\n    if (userStatus['logged in']) {\n      this.renderChart();\n    } else {\n      this.chartRef.current.innerHTML = \"Please log in\";\n    }\n  }\n\n  renderChart() {\n    const {\n      forecast,\n      orgs,\n      userPrediction,\n      confirmed,\n      aggregate\n    } = this.props;\n    var predictionData = {}; //where we will store formatted userPrediction\n\n    const category = this.state.category;\n    var compiledData = []; //format confirmedData, forecastData, and predictionData into a list of js objects, convert date from string to js date object\n\n    var confirmedData = Object.keys(confirmed).map(key => ({\n      date: d3.timeParse(\"%Y-%m-%d\")(key),\n      value: confirmed[key]\n    })); //store userPrediction in predictionData if it exists; parse dates and store as d3 date objects\n\n    if (Object.keys(userPrediction).length > 0) {\n      Object.keys(userPrediction).map(p => {\n        predictionData[p] = userPrediction[p].map(d => ({\n          date: d3.timeParse(\"%Y-%m-%d\")(d.date.substring(0, 10)),\n          value: d.value,\n          defined: d.defined\n        }));\n      });\n    }\n\n    predictionData = sortDictByDate(predictionData);\n    console.log(predictionData); //get most recent prediction\n\n    var dates = sortStringDates(Object.keys(userPrediction));\n    const mostRecentPred = predictionData[dates[dates.length - 1]];\n    console.log(mostRecentPred); //push to compiledData\n\n    const confirmedPath = d3.select(\"#confirmed\");\n    console.log(confirmedPath);\n    const confirmedEndDate = confirmedData[confirmedData.length - 1].date; //confirmedData = getAllDataPoints(confirmedPath, x, y, confirmedData[0], confirmedEndDate);\n\n    compiledData = [confirmedData, mostRecentPred];\n    console.log(dates[0]);\n    console.log(d3.timeFormat(\"%B %d, %Y\")(dates[0])); //IMPORTANT BOUNDARIES// \n\n    const confirmedStartDate = d3.timeParse(\"%Y-%m-%d\")(\"2020-02-01\");\n    const predEndDate = mostRecentPred[mostRecentPred.length - 1].date;\n    const valueMax = 5000;\n    /*dateList.map(d => {\n        dates.push({\n            date: d\n        })\n    })*/\n    /////////////////////////////////////////////////DRAW CHART//////////////////////////////\n    //set up margin, width, height of chart\n\n    const legendWidth = 180;\n    const toolTipHeight = 50; //to make sure there's room for the tooltip when the value is 0\n\n    const contextHeight = 100;\n    var margin = {\n      top: 20,\n      right: 30,\n      bottom: 20,\n      left: 60\n    },\n        width = 800 - margin.left - margin.right,\n        height = 400 - margin.top - margin.bottom;\n    var svg = d3.select(this.chartRef.current).append(\"svg\").attr(\"width\", width + margin.left + margin.right + legendWidth).attr(\"height\", height + margin.top + margin.bottom + toolTipHeight + contextHeight).append(\"g\").attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\"); //Create X axis label   \n\n    svg.append(\"text\").attr(\"x\", width / 2).attr(\"y\", height + 2 * margin.bottom).style(\"text-anchor\", \"middle\").text(\"Date\"); //Create Y axis label\n\n    svg.append(\"text\").attr(\"transform\", \"rotate(-90)\").attr(\"y\", 0 - margin.left).attr(\"x\", 0 - height / 2).attr(\"dy\", \"1em\").style(\"text-anchor\", \"middle\").text(\"Daily Deaths\");\n    var x = d3.scaleTime().domain([confirmedStartDate, predEndDate]).range([0, width]);\n    var xAxis = svg.append(\"g\").attr(\"transform\", \"translate(0,\" + height + \")\").call(d3.axisBottom(x));\n    var y = d3.scaleLinear().domain([0, valueMax]).range([height, 0]);\n    var yAxis = svg.append(\"g\").call(d3.axisLeft(y)); //DRAW LEGEND//\n\n    const legendString = [\"Daily Confirmed Deaths\", \"User Prediction\"];\n    const color = d3.scaleOrdinal().domain(legendString).range(d3.schemeTableau10);\n    const legend = svg.append('g').attr(\"id\", \"legend\");\n    legend.selectAll(\"rect\").data(legendString).enter().append(\"circle\").attr('cx', width + 30).attr(\"cy\", function (d, i) {\n      return 20 + i * 25;\n    }) // 100 is where the first dot appears. 25 is the distance between dots\n    .attr(\"r\", 6) //.attr(\"width\", size)\n    //.attr(\"height\", size)\n    .style(\"fill\", function (d) {\n      return color(d);\n    });\n    legend.selectAll(\"labels\").data(legendString).enter().append(\"text\").attr(\"x\", width + 45).attr(\"y\", function (d, i) {\n      return 20 + i * 25;\n    }) // 100 is where the first dot appears. 25 is the distance between dots\n    .style(\"fill\", function (d) {\n      return color(d);\n    }).text(function (d) {\n      return d;\n    }).attr(\"text-anchor\", \"left\").style(\"alignment-baseline\", \"middle\"); //DRAW TODAY LINE//\n\n    const today = d3.timeParse(\"%Y-%m-%d\")(new Date().toISOString().substring(0, 10));\n    console.log(today);\n    var todayMarker = svg.append(\"g\").attr(\"id\", \"today-marker\");\n    todayMarker.append(\"line\").attr(\"id\", \"today-line\").attr(\"x1\", x(today)).attr(\"x2\", x(today)).attr(\"y1\", 0).attr(\"y2\", height).attr(\"stroke\", \"black\").attr(\"stroke-width\", 1).attr(\"stroke-dasharray\", \"8, 8\");\n    todayMarker.append(\"text\").attr(\"id\", \"today-text\").attr(\"transform\", `translate(${x(today) + 17}, 0) rotate(-90)`).text(\"Today\").style(\"text-anchor\", \"end\"); //SET UP CLIP PATH//\n\n    var mainClip = svg.append(\"defs\").append(\"svg:clipPath\").attr(\"id\", \"main-clip\").append(\"svg:rect\").attr(\"width\", width).attr(\"height\", height).attr(\"x\", 0).attr(\"y\", 0);\n    const mainArea = svg.append(\"g\").attr(\"clip-path\", \"url(#main-clip)\"); //SET UP CURVES//\n\n    const lineGenerator = d3.line().curve(d3.curveCatmullRom);\n    const predLineGenerator = d3.line().curve(d3.curveBasis);\n    const line = lineGenerator.x(function (d) {\n      return x(d.date);\n    }).y(function (d) {\n      return y(d.value);\n    });\n    const predLine = predLineGenerator.defined(d => d.defined).x(function (d) {\n      return x(d.date);\n    }).y(function (d) {\n      return y(d.value);\n    }); //DRAW CURVES//\n\n    var confirmedCurve = mainArea.append(\"path\").attr(\"id\", \"confirmed\").attr(\"class\", \"line\").datum(confirmedData).attr(\"d\", line).attr(\"stroke\", color(legendString[0]));\n    var predCurve = mainArea.append(\"path\").attr(\"id\", \"prediction\").attr(\"class\", \"line\").datum(mostRecentPred.filter(predLine.defined())).attr(\"d\", predLine).attr(\"stroke\", color(legendString[1])); //SET UP TOOLTIP//\n\n    const tooltip = svg.append(\"g\").attr(\"class\", \"tooltip\");\n    tooltip.append(\"path\").attr(\"id\", \"tooltip-line\").style(\"stroke\", \"black\").style(\"stroke-width\", \"0.5px\").style(\"display\", \"none\");\n    var mousePerLine = tooltip.selectAll(\".mouse-per-line\").data(compiledData).enter().append(\"g\").attr(\"class\", \"mouse-per-line\");\n    mousePerLine.append(\"circle\").attr(\"r\", 2).style(\"stroke\", function (d, index) {\n      return color(legendString[index]);\n    }).attr(\"id\", \"circle\").style(\"fill\", \"none\").style(\"stroke-width\", \"1px\").style(\"display\", \"none\");\n    mousePerLine.append(\"text\").attr(\"id\", \"value\").attr(\"transform\", \"translate(10,3)\");\n    mousePerLine.append(\"text\").attr(\"id\", \"date\").attr(\"text-anchor\", \"end\").attr(\"transform\", \"rotate(-90)\");\n    svg.append(\"svg:rect\").attr('width', width).attr('height', height).attr(\"id\", \"interactive-area\").attr('fill', 'none').attr('pointer-events', 'all').style(\"cursor\", \"pointer\").on('mouseout', function () {\n      // on mouse out hide line, circles and text\n      d3.select(\"#tooltip-line\").style(\"display\", \"none\");\n      d3.selectAll(\".mouse-per-line circle\").style(\"display\", \"none\");\n      d3.selectAll(\".mouse-per-line text\").style(\"display\", \"none\");\n    })\n    /*.on('mouseover', function() { // on mouse in show line, circles and text\n        d3.select(\"#tooltip-line\")\n            .style(\"opacity\", \"1\");\n        d3.selectAll(\".mouse-per-line circle\")\n            .style(\"opacity\", \"1\");\n        d3.selectAll(\".mouse-per-line text\")\n            .style(\"opacity\", \"1\")\n    })*/\n    .on('mousemove', function () {\n      // mouse moving over canvas\n      var todayDate = new Date();\n      todayDate = d3.timeParse(\"%Y-%m-%d\")(todayDate.toISOString().substring(0, 10));\n      var date = x.invert(d3.mouse(this)[0]);\n\n      if (+date > +todayDate) {\n        date = todayDate;\n      }\n\n      const index = d3.bisectRight(dates, date);\n\n      if (predictionData[date]) {\n        console.log(\"exists\");\n        svg.select(\"#prediction\").datum(predictionData[date].filter(predLine.defined())).attr(\"d\", predLine);\n        compiledData[1] = predictionData[date];\n      } else {\n        if (index == 0) {\n          svg.select(\"#prediction\").datum([]).attr(\"d\", predLine);\n          compiledData[1] = [];\n        } else {\n          var newDate = dates[index - 1];\n          console.log(+predictionData[newDate][0].date, +date);\n          var pred = predictionData[newDate].filter(d => +d.date >= +date);\n          console.log(pred);\n          svg.select(\"#prediction\").datum(pred.filter(predLine.defined())).attr(\"d\", predLine);\n          compiledData[1] = pred;\n        }\n      }\n\n      mousePerLine.data(compiledData); ////////////////////\n\n      var mouse = d3.mouse(this);\n      var xCoord = mouse[0];\n      d3.select(\"#tooltip-line\").attr(\"d\", function () {\n        var d = \"M\" + xCoord + \",\" + height;\n        d += \" \" + xCoord + \",\" + 0;\n        return d;\n      });\n      d3.selectAll(\".mouse-per-line\").attr(\"transform\", function (d, i) {\n        if (d.length == 0) {\n          return;\n        }\n\n        var date = x.invert(xCoord);\n        const index = d3.bisector(f => f.date).left(d, date);\n        var a = null;\n\n        if (index > 0) {\n          a = d[index - 1];\n        }\n\n        const b = d[index]; //d = the data object corresponding to date and value pointed by the cursors\n\n        var data = null;\n\n        if (!a) {\n          data = b;\n        } else if (!b) {\n          data = a;\n        } else {\n          data = b && date - a.date > b.date - date ? b : a;\n        }\n\n        if (+d3.timeDay.floor(date) == +data.date || +d3.timeDay.ceil(date) == +data.date) {\n          if (data.defined != 0) {\n            var element = d3.select(this);\n            element.select('#value').style(\"display\", \"block\").text(Math.round(data.value)).attr(\"transform\", `translate(${mouse[0]}, ${y(data.value)})`);\n            element.select(\"#date\").style(\"display\", \"block\").attr(\"transform\", `translate(${mouse[0] + 15}, 0) rotate(-90)`).text(d3.timeFormat(\"%B %d, %Y\")(data.date));\n            element.select(\"circle\").style(\"display\", \"block\").attr(\"transform\", `translate(${mouse[0]}, ${y(data.value)})`);\n            return \"translate(0,0)\";\n          }\n        }\n\n        var element = d3.select(this);\n        element.selectAll(\"text\").style(\"display\", \"none\");\n        element.select(\"circle\").style(\"display\", \"none\");\n      });\n    }).on(\"click\", function () {\n      var date = x.invert(d3.mouse(this)[0]);\n      const index = d3.bisectRight(dates, date);\n      console.log(dates);\n      console.log(date);\n      console.log(index);\n\n      if (predictionData[date]) {\n        console.log(\"exists\");\n        svg.select(\"#prediction\").datum(predictionData[date].filter(predLine.defined())).attr(\"d\", predLine);\n        compiledData[1] = predictionData[date];\n      } else {\n        if (index == 0) {\n          svg.select(\"#prediction\").datum([]).attr(\"d\", predLine);\n          compiledData[1] = [];\n        } else {\n          var newDate = dates[index - 1];\n          console.log(+predictionData[newDate][0].date, +date);\n          var pred = predictionData[newDate].filter(d => +d.date >= +date);\n          console.log(pred);\n          svg.select(\"#prediction\").datum(pred.filter(predLine.defined())).attr(\"d\", predLine);\n          compiledData[1] = pred;\n        }\n      }\n\n      mousePerLine.data(compiledData);\n    });\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      ref: this.chartRef,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 416,\n        columnNumber: 16\n      }\n    });\n  }\n\n}\n\nexport default UserPredictionChart;","map":{"version":3,"sources":["/Users/sarah/Documents/Sarah/Projects/reu/covid19-forecasting-market/frontend/src/components/UserPredictionChart/index.js"],"names":["React","Component","d3","getMostRecentPrediction","getAllDataPoints","sortDictByDate","sortStringDates","UserPredictionChart","constructor","props","state","category","chartRef","createRef","componentDidMount","userStatus","console","log","renderChart","current","innerHTML","forecast","orgs","userPrediction","confirmed","aggregate","predictionData","compiledData","confirmedData","Object","keys","map","key","date","timeParse","value","length","p","d","substring","defined","dates","mostRecentPred","confirmedPath","select","confirmedEndDate","timeFormat","confirmedStartDate","predEndDate","valueMax","legendWidth","toolTipHeight","contextHeight","margin","top","right","bottom","left","width","height","svg","append","attr","style","text","x","scaleTime","domain","range","xAxis","call","axisBottom","y","scaleLinear","yAxis","axisLeft","legendString","color","scaleOrdinal","schemeTableau10","legend","selectAll","data","enter","i","today","Date","toISOString","todayMarker","mainClip","mainArea","lineGenerator","line","curve","curveCatmullRom","predLineGenerator","curveBasis","predLine","confirmedCurve","datum","predCurve","filter","tooltip","mousePerLine","index","on","todayDate","invert","mouse","bisectRight","newDate","pred","xCoord","bisector","f","a","b","timeDay","floor","ceil","element","Math","round","render"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport './UserPredictionChart.css';\nimport { getMostRecentPrediction, getAllDataPoints, sortDictByDate, sortStringDates } from '../../utils/data';\n\nclass UserPredictionChart extends Component {\n    constructor(props) {\n        super(props);\n        this.state = { category: \"us_daily_deaths\" };\n        this.chartRef = React.createRef();\n    }\n\n    componentDidMount() {\n        const userStatus = this.props.userStatus;\n        console.log(userStatus)\n        if (userStatus['logged in']) {\n            this.renderChart();\n        }\n        else {\n            this.chartRef.current.innerHTML = \"Please log in\"\n        }\n    }\n    renderChart() {\n        const { forecast, orgs, userPrediction, confirmed, aggregate } = this.props;\n        var predictionData = {};//where we will store formatted userPrediction\n        const category = this.state.category;\n        var compiledData = [];\n\n        //format confirmedData, forecastData, and predictionData into a list of js objects, convert date from string to js date object\n        var confirmedData = Object.keys(confirmed).map(key => ({\n            date: d3.timeParse(\"%Y-%m-%d\")(key),\n            value: confirmed[key]\n        }));\n\n        //store userPrediction in predictionData if it exists; parse dates and store as d3 date objects\n        if(Object.keys(userPrediction).length > 0) {\n            Object.keys(userPrediction).map(p => {\n                predictionData[p]= userPrediction[p].map(d => ({\n                    date: d3.timeParse(\"%Y-%m-%d\")((d.date).substring(0,10)),\n                    value: d.value,\n                    defined: d.defined\n                }))\n            })\n        }\n        predictionData = sortDictByDate(predictionData);\n        console.log(predictionData)\n        //get most recent prediction\n        var dates = sortStringDates(Object.keys(userPrediction))\n        const mostRecentPred = predictionData[dates[dates.length - 1]]\n        console.log(mostRecentPred)\n        //push to compiledData\n        const confirmedPath = d3.select(\"#confirmed\");\n        console.log(confirmedPath);\n        const confirmedEndDate = confirmedData[confirmedData.length - 1].date;\n        //confirmedData = getAllDataPoints(confirmedPath, x, y, confirmedData[0], confirmedEndDate);\n        compiledData = [confirmedData, mostRecentPred]\n        console.log(dates[0])\n        console.log(d3.timeFormat(\"%B %d, %Y\")(dates[0]))\n    \n\n        //IMPORTANT BOUNDARIES// \n        const confirmedStartDate = d3.timeParse(\"%Y-%m-%d\")(\"2020-02-01\");\n        const predEndDate = mostRecentPred[mostRecentPred.length - 1].date;\n        const valueMax = 5000;\n        \n\n        /*dateList.map(d => {\n            dates.push({\n                date: d\n            })\n        })*/\n\n        /////////////////////////////////////////////////DRAW CHART//////////////////////////////\n        //set up margin, width, height of chart\n        const legendWidth = 180;\n        const toolTipHeight = 50; //to make sure there's room for the tooltip when the value is 0\n        const contextHeight = 100;\n        var margin = {top: 20, right: 30, bottom: 20, left: 60},\n            width = 800 - margin.left - margin.right,\n            height = 400 - margin.top - margin.bottom;\n        var svg = d3.select(this.chartRef.current)\n                    .append(\"svg\")\n                        .attr(\"width\", width + margin.left + margin.right + legendWidth)\n                        .attr(\"height\", height + margin.top + margin.bottom + toolTipHeight + contextHeight)\n                    .append(\"g\")\n                        .attr(\"transform\",\n                        \"translate(\" + margin.left + \",\" + margin.top + \")\");\n        \n        //Create X axis label   \n        svg.append(\"text\")\n            .attr(\"x\", width/2)\n            .attr(\"y\", height + 2*margin.bottom)\n            .style(\"text-anchor\", \"middle\")\n            .text(\"Date\");\n            \n        //Create Y axis label\n        svg.append(\"text\")\n            .attr(\"transform\", \"rotate(-90)\")\n            .attr(\"y\", 0 - margin.left)\n            .attr(\"x\", 0 - (height/2))\n            .attr(\"dy\", \"1em\")\n            .style(\"text-anchor\", \"middle\")\n            .text(\"Daily Deaths\");\n\n        var x = d3\n                    .scaleTime()\n                    .domain([confirmedStartDate, predEndDate])\n                    .range([0, width]);\n        var xAxis = svg\n                        .append(\"g\")\n                        .attr(\"transform\", \"translate(0,\" + height + \")\")\n                        .call(d3.axisBottom(x));\n        var y = d3\n                    .scaleLinear()\n                    .domain([0, valueMax])\n                    .range([height, 0]);\n        var yAxis = svg\n                        .append(\"g\")\n                        .call(d3.axisLeft(y));\n        \n        //DRAW LEGEND//\n        const legendString = [\"Daily Confirmed Deaths\", \"User Prediction\"];\n        const color = d3\n                        .scaleOrdinal()\n                        .domain(legendString)\n                        .range(d3.schemeTableau10);\n        const legend = svg\n                            .append('g')\n                            .attr(\"id\", \"legend\");\n        legend\n                .selectAll(\"rect\")\n                .data(legendString)\n                .enter()\n                .append(\"circle\")\n                    .attr('cx', width + 30)\n                    .attr(\"cy\", function(d,i){ return 20 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots\n                    .attr(\"r\", 6)\n                    //.attr(\"width\", size)\n                    //.attr(\"height\", size)\n                    .style(\"fill\", function(d){ return color(d)})\n        legend\n                .selectAll(\"labels\")\n                .data(legendString)\n                .enter()\n                .append(\"text\")\n                    .attr(\"x\", width + 45)\n                    .attr(\"y\", function(d,i){ return 20 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots\n                    .style(\"fill\", function(d){ return color(d)})\n                    .text(function(d){ return d})\n                        .attr(\"text-anchor\", \"left\")\n                        .style(\"alignment-baseline\", \"middle\")\n        \n        //DRAW TODAY LINE//\n        const today = d3.timeParse(\"%Y-%m-%d\")(new Date().toISOString().substring(0,10));\n        console.log(today);\n        var todayMarker = svg\n                            .append(\"g\")\n                            .attr(\"id\", \"today-marker\")\n        todayMarker\n                    .append(\"line\")\n                    .attr(\"id\", \"today-line\")\n                    .attr(\"x1\", x(today))\n                    .attr(\"x2\", x(today))\n                    .attr(\"y1\", 0)\n                    .attr(\"y2\", height)\n                    .attr(\"stroke\", \"black\")\n                    .attr(\"stroke-width\", 1)\n                    .attr(\"stroke-dasharray\", \"8, 8\")\n        todayMarker\n                    .append(\"text\")\n                    .attr(\"id\", \"today-text\")\n                    .attr(\"transform\", `translate(${x(today) + 17}, 0) rotate(-90)`)\n                    .text(\"Today\")\n                    .style(\"text-anchor\", \"end\")\n\n        //SET UP CLIP PATH//\n        var mainClip = svg\n                            .append(\"defs\")\n                            .append(\"svg:clipPath\")\n                                .attr(\"id\", \"main-clip\")\n                                .append(\"svg:rect\")\n                                    .attr(\"width\", width )\n                                    .attr(\"height\", height )\n                                    .attr(\"x\", 0)\n                                    .attr(\"y\", 0);\n        const mainArea = svg.append(\"g\")\n                            .attr(\"clip-path\", \"url(#main-clip)\");\n        \n        //SET UP CURVES//\n        const lineGenerator = d3.line()\n                                .curve(d3.curveCatmullRom);\n        const predLineGenerator = d3.line()\n                                    .curve(d3.curveBasis);\n        const line = lineGenerator\n                        .x(function(d) { return x(d.date) })\n                        .y(function(d) { return y(d.value) })\n        const predLine = predLineGenerator\n                            .defined(d => d.defined)\n                            .x(function(d) { return x(d.date) })\n                            .y(function(d) { return y(d.value) })\n        //DRAW CURVES//\n        var confirmedCurve = mainArea\n                                    .append(\"path\")\n                                    .attr(\"id\", \"confirmed\")\n                                    .attr(\"class\", \"line\")\n                                    .datum(confirmedData)\n                                    .attr(\"d\", line)\n                                    .attr(\"stroke\", color(legendString[0]))\n        var predCurve = mainArea\n                                .append(\"path\")\n                                .attr(\"id\", \"prediction\")\n                                .attr(\"class\", \"line\")\n                                .datum(mostRecentPred.filter(predLine.defined()))\n                                .attr(\"d\", predLine)\n                                .attr(\"stroke\",  color(legendString[1]))\n        \n        //SET UP TOOLTIP//\n        const tooltip = svg \n                            .append(\"g\")\n                            .attr(\"class\", \"tooltip\")\n        tooltip\n                .append(\"path\")\n                .attr(\"id\", \"tooltip-line\")\n                .style(\"stroke\", \"black\")\n                .style(\"stroke-width\", \"0.5px\")\n                .style(\"display\", \"none\");\n        var mousePerLine = tooltip\n                                    .selectAll(\".mouse-per-line\")\n                                    .data(compiledData)\n                                    .enter()\n                                    .append(\"g\")\n                                    .attr(\"class\", \"mouse-per-line\");\n        mousePerLine.append(\"circle\")\n                    .attr(\"r\", 2)\n                    .style(\"stroke\", function(d, index) {\n                        return color(legendString[index]);\n                    })\n                    .attr(\"id\", \"circle\")\n                    .style(\"fill\", \"none\")\n                    .style(\"stroke-width\", \"1px\")\n                    .style(\"display\", \"none\");\n        mousePerLine.append(\"text\")\n                    .attr(\"id\", \"value\")\n                    .attr(\"transform\", \"translate(10,3)\"); \n        mousePerLine.append(\"text\")\n                    .attr(\"id\", \"date\")\n                    .attr(\"text-anchor\", \"end\")\n                    .attr(\"transform\", \"rotate(-90)\")\n        \n        svg\n                .append(\"svg:rect\")\n                    .attr('width', width)\n                    .attr('height', height)\n                    .attr(\"id\", \"interactive-area\")\n                    .attr('fill', 'none')\n                    .attr('pointer-events', 'all')\n                    .style(\"cursor\", \"pointer\")\n                    .on('mouseout', function() { // on mouse out hide line, circles and text\n                        d3.select(\"#tooltip-line\")\n                            .style(\"display\", \"none\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                            .style(\"display\", \"none\");\n                        d3.selectAll(\".mouse-per-line text\")\n                            .style(\"display\", \"none\")\n                    })\n                    /*.on('mouseover', function() { // on mouse in show line, circles and text\n                        d3.select(\"#tooltip-line\")\n                            .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line circle\")\n                            .style(\"opacity\", \"1\");\n                        d3.selectAll(\".mouse-per-line text\")\n                            .style(\"opacity\", \"1\")\n                    })*/\n                    .on('mousemove', function() { // mouse moving over canvas\n                        var todayDate = new Date();\n                        todayDate = d3.timeParse(\"%Y-%m-%d\")(todayDate.toISOString().substring(0,10));\n                        var date = x.invert(d3.mouse(this)[0])\n                        if (+date > +todayDate) {\n                            date = todayDate;\n                        }\n                        const index = d3.bisectRight(dates, date);\n                        if(predictionData[date]) {\n                            console.log(\"exists\")\n                            svg\n                                .select(\"#prediction\")\n                                .datum(predictionData[date].filter(predLine.defined()))\n                                .attr(\"d\", predLine)\n                            compiledData[1] = predictionData[date];\n                        }\n                        else {\n                            if (index == 0) {\n                                svg\n                                    .select(\"#prediction\")\n                                    .datum([])\n                                    .attr(\"d\", predLine)\n                                compiledData[1] = [];\n                            }\n                            else {\n                                var newDate = dates[index - 1];\n                                console.log(+predictionData[newDate][0].date, +date);\n                                var pred = predictionData[newDate].filter(d => +d.date >= +date)\n                                console.log(pred)\n                                svg\n                                    .select(\"#prediction\")\n                                    .datum(pred.filter(predLine.defined()))\n                                    .attr(\"d\", predLine);\n                                compiledData[1] = pred;\n                            }\n                        }\n                        mousePerLine.data(compiledData);\n                        ////////////////////\n\n\n\n                        var mouse = d3.mouse(this);\n                        var xCoord = mouse[0];\n                        d3\n                            .select(\"#tooltip-line\")\n                            .attr(\"d\", function() {\n                                var d = \"M\" + xCoord + \",\" + height;\n                                d += \" \" + xCoord + \",\" + 0;\n                                return d;\n                            });\n                        d3\n                            .selectAll(\".mouse-per-line\")\n                            .attr(\"transform\", function(d, i) {\n                                if (d.length == 0) {return;}\n                                var date = x.invert(xCoord);\n                                const index = d3.bisector(f => f.date).left(d, date);\n                                var a = null;\n                                if (index > 0) {\n                                    a = d[index - 1];\n                                }\n                                const b = d[index];\n                                //d = the data object corresponding to date and value pointed by the cursors\n                                var data = null;\n                                if (!a) {\n                                    data = b;\n                                }\n                                else if (!b) {\n                                    data = a;\n                                }\n                                else {\n                                    data = b && (date - a.date > b.date - date) ? b : a;\n                                }\n                                if (+d3.timeDay.floor(date) == +data.date || +d3.timeDay.ceil(date) == +data.date) {\n                                    if (data.defined != 0) {\n                                        var element = d3.select(this)\n                                        element\n                                                .select('#value')\n                                                .style(\"display\", \"block\")\n                                                .text(Math.round(data.value))\n                                                .attr(\"transform\", `translate(${mouse[0]}, ${y(data.value)})`);\n                                            \n                                        element\n                                                .select(\"#date\")\n                                                .style(\"display\", \"block\")\n                                                .attr(\"transform\", `translate(${mouse[0] + 15}, 0) rotate(-90)`)\n                                                .text(d3.timeFormat(\"%B %d, %Y\")(data.date));\n                                        element\n                                                .select(\"circle\")\n                                                .style(\"display\", \"block\")\n                                                .attr(\"transform\", `translate(${mouse[0]}, ${y(data.value)})`);\n                                        return \"translate(0,0)\";\n                                    }\n                                }\n                                var element = d3.select(this)\n                                element                \n                                    .selectAll(\"text\")\n                                        .style(\"display\", \"none\")\n                                element\n                                        .select(\"circle\")\n                                        .style(\"display\", \"none\");\n                            });\n                    })\n                    .on(\"click\", function() {\n                        var date = x.invert(d3.mouse(this)[0])\n                        const index = d3.bisectRight(dates, date);\n                        console.log(dates)\n                        console.log(date)\n                        console.log(index)\n                        if(predictionData[date]) {\n                            console.log(\"exists\")\n                            svg\n                                .select(\"#prediction\")\n                                .datum(predictionData[date].filter(predLine.defined()))\n                                .attr(\"d\", predLine)\n                            compiledData[1] = predictionData[date];\n                        }\n                        else {\n                            if (index == 0) {\n                                svg\n                                    .select(\"#prediction\")\n                                    .datum([])\n                                    .attr(\"d\", predLine)\n                                compiledData[1] = [];\n                            }\n                            else {\n                                var newDate = dates[index - 1];\n                                console.log(+predictionData[newDate][0].date, +date);\n                                var pred = predictionData[newDate].filter(d => +d.date >= +date)\n                                console.log(pred)\n                                svg\n                                    .select(\"#prediction\")\n                                    .datum(pred.filter(predLine.defined()))\n                                    .attr(\"d\", predLine);\n                                compiledData[1] = pred;\n                            }\n                        }\n                        mousePerLine.data(compiledData);\n                    })\n                \n    }\n\n    render() {\n        return(<div ref={this.chartRef}></div>);\n    }\n}\n\nexport default UserPredictionChart;\n"]},"metadata":{},"sourceType":"module"}